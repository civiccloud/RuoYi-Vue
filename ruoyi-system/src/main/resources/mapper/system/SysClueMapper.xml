<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.SysClueMapper">

	<resultMap type="com.ruoyi.system.domain.SysClue" id="SysClueResult">
		<id     property="id"        column="id"           />
		<result property="clueSn"      column="clue_sn"         />
		<result property="userId"      column="user_id"         />
		<result property="userName"      column="user_name"         />
		<result property="deptId"        column="dept_id"            />
		<result property="deptName"        column="dept_name"            />
		<result property="name"        column="name"            />
		<result property="mobile" column="mobile"    />
		<result property="mobileCity"       column="mobile_city"           />
		<result property="ipCity"       column="ip_city"           />
		<result property="ipaddr"       column="ipaddr"           />
		<result property="status"       column="status"           />
		<result property="delFlag"    column="del_flag"    />
		<result property="updateTime"            column="update_time"                />
		<result property="updateBy"           column="update_by"               />
		<result property="createTime"     column="create_time"        />
		<result property="createBy"     column="create_by"        />
	</resultMap>


	<sql id="selectClueVo">
		select sc.id, sc.clue_sn,
			   sc.user_id,
			   u.user_name,
			   sc.dept_id,
			   d.dept_name,
			   sc.name, sc.mobile, sc.mobile_city, sc.ip_city, sc.ipaddr, sc.status, sc.del_flag, sc.update_time, sc.update_by, sc.create_time, sc.create_by
		from sys_clue sc
				 left join sys_user u on sc.user_id = u.user_id
				 left join sys_dept d on sc.dept_id = d.dept_id
	</sql>

	<insert id="insertSysClue" parameterType="com.ruoyi.system.domain.SysClue">
		insert into
		sys_clue (clue_sn, user_id, dept_id, name, mobile, mobile_city, ip_city, ipaddr, create_by, create_time)
		values (#{clueSn}, #{userId}, #{deptId}, #{name}, #{mobile}, #{mobileCity}, #{ipCity}, #{ipaddr}, #{createBy}, sysdate())
	</insert>
	
	<select id="selectSysClueList" parameterType="com.ruoyi.system.domain.SysClue" resultMap="SysClueResult">
		<include refid="selectClueVo"/>
		<where>
			sc.del_flag = '0'
			<if test="id != null and id != ''">
				AND sc.id = #{id}
			</if>
			<if test="clueSn != null and clueSn != ''">
				AND sc.clue_sn = #{clueSn}
			</if>
			<if test="userId != null and userId != ''">
				AND sc.user_id = #{userId}
			</if>
			<if test="deptId != null and deptId != ''">
				AND sc.dept_id = #{deptId}
			</if>
			<if test="name != null and name != ''">
				AND sc.name like concat('%', #{name}, '%')
			</if>
			<if test="mobile != null and mobile != ''">
				AND sc.mobile like concat('%', #{mobile}, '%')
			</if>
			<if test="ipaddr != null and ipaddr != ''">
				AND sc.ipaddr like concat('%', #{ipaddr}, '%')
			</if>
			<if test="status != null">
				AND sc.status = #{status}
			</if>
			<if test="params.beginTime != null and params.beginTime != ''">
				<!-- 开始时间检索 -->
				AND date_format(sc.create_time,'%y%m%d') &gt;= date_format(#{params.beginTime},'%y%m%d')
			</if>
			<if test="params.endTime != null and params.endTime != ''">
				<!-- 结束时间检索 -->
				AND date_format(sc.create_time,'%y%m%d') &lt;= date_format(#{params.endTime},'%y%m%d')
			</if>
			<if test="updateBy != null and updateBy != ''">
				AND sc.update_by like concat('%', #{updateBy}, '%')
			</if>
			<if test="createBy != null and createBy != ''">
				AND sc.create_by like concat('%', #{createBy}, '%')
			</if>
		</where>
		order by id desc
		<!-- 数据范围过滤 -->
		${params.dataScope}
	</select>
	
	<delete id="deleteSysClueByIds" parameterType="Long">
 		delete from sys_clue where id in
 		<foreach collection="array" item="id" open="(" separator="," close=")">
 			#{id}
        </foreach> 
 	</delete>
    
    <update id="cleanSysClue">
        truncate table sys_clue
    </update>

	<!-- 获取线索编号 -->
	<select id="checkProjectSn" resultType="String">
		select
			CONCAT(DATE_FORMAT( NOW(), '%Y%m%d' ), LPAD( count( id ) + 1, 3, 0 ))
		from
			sys_clue
		where
			del_flag = '0' and to_days( create_time ) = to_days(now())
	</select>

	<select id="selectSysClueListByIds" resultMap="SysClueResult">
		SELECT
			sc.user_id,
			count( id ) as count
		FROM sys_clue sc
			<where> sc.id in
				<foreach collection="ids" item="id" open="(" separator="," close=")">
					#{id}
				</foreach>
				and to_days( create_time ) = to_days(now())
			</where>
		GROUP BY user_id
	</select>

	<select id="selectSysClueByInfo" resultMap="SysClueResult">
		<include refid="selectClueVo"/>
		<where>
			sc.del_flag = '0'
			<if test="id != null and id != ''">
				AND sc.id = #{id}
			</if>
			<if test="mobile != null and mobile != ''">
				AND sc.mobile = #{mobile}
			</if>
		</where>
		order by sc.user_id limit 1
	</select>

	<update id="updateClue" parameterType="com.ruoyi.system.domain.SysClue">
		update sys_clue
		<set>
			user_id = #{userId},
			dept_id = #{deptId},
			<if test="clueSn != null and clueSn != ''">clue_sn = #{clueSn},</if>
			<if test="name != null ">name = #{name},</if>
			<if test="mobile != null ">mobile = #{mobile},</if>
			<if test="mobileCity != null and mobileCity != ''">mobile_city = #{mobileCity},</if>
			<if test="ipaddr != null and ipaddr != ''">ipaddr = #{ipaddr},</if>
			<if test="ipCity != null and ipCity != ''">ip_city = #{ipCity},</if>
			<if test="status != null and status != ''">status = #{status},</if>
			<if test="delFlag != null">del_flag = #{delFlag},</if>
			<if test="remark != null">remark = #{remark},</if>
			<if test="updateBy != null and updateBy != ''">update_by = #{updateBy},</if>
			update_time = sysdate()
		</set>
		where id = #{id}
	</update>
</mapper>